---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction to relational data with dplyr

```{r}
library(tidyverse, warn.conflicts = FALSE)
```

## Relational data

* A collection of related tables of data.
* The relations are always defined between a pair of tables, by the keys.

```{r echo = FALSE}
# styler: off
companies = tribble(
  ~companies_id,                                 ~information,
              1,    "alpha sells solar panels and wind mills",
              2, "beta sells steel and installs solar panels",
)

categories = tribble(
  ~companies_id,      ~sector,
              1,     "energy",
              2, "metallurgy",
              2,     "energy",
)
# styler: on
```

```{r echo = FALSE, message=FALSE}
library(dm)
database <- dm(companies, categories) |>
  dm_add_pk(companies, companies_id) |>
  dm_add_fk(categories, companies_id, companies)
database |> dm_draw()
```


```{r}
companies

categories

key <- "companies_id"
left_join(companies, categories, by = key)
```

Validate.

https://r4ds.had.co.nz/relational-data.html#join-problems

* All values of a primary key should be unique.
* No value of a primary key should be missing.
* All values of a foreign key should match a value of a primary key.

```{r}
companies |>
  count(companies_id) |>
  filter(n > 1)

categories |>
  count(companies_id) |>
  filter(n > 1)
```


TODO: 

* Introduce toy dataset.
* Show relationship with dm

## Types of joins

**Mutating join** add new variables to one data frame from matching observations in another.

* Inner

TODO SHOW EXAMPLE WITH TOY DATASET

* Outter

TODO SHOW EXAMPLE WITH TOY DATASET

* Duplicate keys

**Filtering joins** filter observations from one data frame based on whether or not they match an observation in the other table.

TODO SHOW EXAMPLE WITH TOY DATASET

Filtering joins, which filter observations from one data frame based on whether or not they match an observation in the other table.

TODO SHOW EXAMPLE WITH TOY DATASET
